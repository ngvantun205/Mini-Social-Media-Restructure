@model List<Mini_Social_Media.Models.ViewModel.PostViewModel>
@{
    var currentUserIdStr = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
    var currentUserId = string.IsNullOrEmpty(currentUserIdStr) ? 0 : int.Parse(currentUserIdStr);
}

@foreach (var post in Model) {
    var isOwner = post.Owner.UserId == currentUserId;

    <div class="post-card" data-post-id="@post.PostId">

        <!-- POST HEADER -->
        <div class="post-card-header">
            <img src="@post.Owner.AvatarUrl" class="post-user-avatar" alt="@post.Owner.UserName" />

            <div class="post-user-details">
                <h5 class="post-username">@post.Owner.UserName</h5>
                @if (!string.IsNullOrEmpty(post.Location)) {
                    <p class="post-location">
                        <i class="bi bi-geo-alt-fill"></i> @post.Location
                    </p>
                }
                <div class="post-timestamp">@post.CreatedAt.ToString("dd/MM/yyyy HH:mm")</div>
            </div>

            <div class="post-dropdown">
                <button class="post-menu-btn" onclick="togglePostMenu(this, @post.PostId, @isOwner.ToString().ToLower())">
                    <i class="bi bi-three-dots"></i>
                </button>

                <div class="post-dropdown-menu">
                    @if (post.Owner.UserId == currentUserId) {
                        <button class="dropdown-item-custom" onclick="goToEditPost(@post.PostId)">
                            <i class="bi bi-pencil"></i>
                            Edit Post
                        </button>
                        <button class="dropdown-item-custom danger" onclick="confirmDeletePost(@post.PostId)">
                            <i class="bi bi-trash"></i>
                            Delete Post
                        </button>
                    }
                    else {
                        <button class="dropdown-item-custom" onclick="goToPostDetail(@post.PostId)">
                            <i class="bi bi-eye"></i>
                            View Details
                        </button>
                        <button class="dropdown-item-custom danger" onclick="reportPost(@post.PostId)">
                            <i class="bi bi-flag"></i>
                            Report
                        </button>
                    }
                </div>
            </div>
        </div>

        <!-- CAPTION -->
        @if (!string.IsNullOrEmpty(post.Caption)) {
            <div class="post-caption">
                <span>@post.Caption</span>
            </div>
        }

        <!-- HASHTAGS -->
        @if (!string.IsNullOrEmpty(post.Hashtags)) {
            <div class="post-hashtags">
                @foreach (var tag in post.Hashtags.Split(' ', StringSplitOptions.RemoveEmptyEntries)) {
                    var displayTag = tag.StartsWith("#") ? tag : "#" + tag;
                    <a href="#" class="hashtag-tag">@displayTag</a>
                }
            </div>
        }

        <!-- MEDIA -->
        @if (post.Medias != null && post.Medias.Any()) {
            <div class="post-media-section">
                @if (post.Medias.Count == 1) {
                    var media = post.Medias.First();
                    @if (media.MediaType == "video") {
                        <video controls>
                            <source src="@media.Url" type="video/mp4" />
                        </video>
                    }
                    else {
                        <img src="@media.Url" alt="Post media" />
                    }
                }
                else {
                    <div id="carousel-@post.PostId" class="carousel slide" data-bs-ride="carousel">
                        <div class="carousel-inner">
                            @for (int i = 0; i < post.Medias.Count; i++) {
                                var media = post.Medias[i];
                                <div class="carousel-item @(i == 0 ? "active" : "")">
                                    @if (media.MediaType == "video") {
                                        <video controls style="width: 100%; object-fit: contain;">
                                            <source src="@media.Url" type="video/mp4" />
                                        </video>
                                    }
                                    else {
                                        <img src="@media.Url" class="d-block w-100" alt="Post media">
                                    }
                                </div>
                            }
                        </div>
                        <button class="carousel-control-prev" type="button" data-bs-target="#carousel-@post.PostId" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon"></span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#carousel-@post.PostId" data-bs-slide="next">
                            <span class="carousel-control-next-icon"></span>
                        </button>
                    </div>
                }
            </div>
        }

        <div class="post-actions-section">
            <div class="post-action-buttons">
                <button class="action-btn @(post.IsLiked ? "liked" : "")" onclick="toggleLike(this, @post.PostId)">
                    <i class="bi @(post.IsLiked ? "bi-heart-fill text-danger" : "bi-heart")"></i>
                </button>

                <a class="action-btn" asp-controller="Post" asp-action="PostDetails" asp-route-id="@post.PostId">
                    <i class="bi bi-chat"></i>
                </a>

                <button class="action-btn">
                    <i class="bi bi-send"></i>
                </button>
            </div>

            <div class="post-stats">
                <p class="likes-count">
                    <span class="like-number">@post.LikeCount</span> @(post.LikeCount == 1 ? "like" : "likes")
                </p>
                <a asp-controller="Post" asp-action="PostDetails" asp-route-id="@post.PostId" class="view-comments-link">
                    View all @post.CommentCount comments
                </a>
            </div>
        </div>
    </div>
}