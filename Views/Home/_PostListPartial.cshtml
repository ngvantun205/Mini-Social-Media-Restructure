@model List<Mini_Social_Media.Models.ViewModel.PostViewModel>
@{
    var currentUserIdStr = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
    var currentUserId = string.IsNullOrEmpty(currentUserIdStr) ? 0 : int.Parse(currentUserIdStr);
}

@foreach (var post in Model) {
    var isOwner = post.Owner.UserId == currentUserId;

    <div class="post-card" data-post-id="@post.PostId">

        <!-- POST HEADER -->
        <div class="post-card-header">
            @if (currentUserId != post.Owner.UserId) {
                <a asp-controller="Profile" asp-action="UserProfile" asp-route-id="@post.Owner.UserId" class="post-avatar-link">
                    <img src="@post.Owner.AvatarUrl" class="post-user-avatar" alt="@post.Owner.UserName" />
                </a>
            }
            else {
                <a asp-controller="Profile" asp-action="MyProfile" class="post-avatar-link">
                    <img src="@post.Owner.AvatarUrl" class="post-user-avatar" alt="@post.Owner.UserName" />
                </a>
            }

            <div class="post-user-details">
                @if (currentUserId != post.Owner.UserId) {
                    <a asp-controller="Profile" asp-action="UserProfile" asp-route-id="@post.Owner.UserId" class="post-username-link">
                        <h5 class="post-username">@post.Owner.UserName</h5>
                    </a>
                }
                else {
                    <a asp-controller="Profile" asp-action="MyProfile" class="post-username-link">
                        <h5 class="post-username">@post.Owner.UserName</h5>
                    </a>
                }

                @if (!string.IsNullOrEmpty(post.Location)) {
                    <p class="post-location">
                        <i class="bi bi-geo-alt-fill"></i> @post.Location
                    </p>
                }
            </div>

            <div class="post-header-right">
                <div class="post-timestamp">@post.CreatedAt.ToString("dd/MM/yyyy HH:mm")</div>

                <div class="post-dropdown">
                    <button class="post-menu-btn" onclick="togglePostMenu(this, @post.PostId, @isOwner.ToString().ToLower())">
                        <i class="bi bi-three-dots"></i>
                    </button>

                    <div class="post-dropdown-menu">
                        @if (post.Owner.UserId == currentUserId) {
                            <button class="dropdown-item-custom" onclick="goToEditPost(@post.PostId)">
                                <i class="bi bi-pencil"></i>
                                Edit Post
                            </button>
                            <button class="dropdown-item-custom danger" onclick="confirmDeletePost(@post.PostId)">
                                <i class="bi bi-trash"></i>
                                Delete Post
                            </button>
                        }
                        else {
                            <button class="dropdown-item-custom" onclick="goToPostDetail(@post.PostId)">
                                <i class="bi bi-eye"></i>
                                View Details
                            </button>
                            <button class="dropdown-item-custom danger" onclick="reportPost(@post.PostId)">
                                <i class="bi bi-flag"></i>
                                Report
                            </button>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- MEDIA -->
        @if (post.Medias != null && post.Medias.Any()) {
            <div class="post-media-section">
                @if (post.Medias.Count == 1) {
                    var media = post.Medias.First();
                    @if (media.MediaType == "video") {
                        <video controls class="post-single-media">
                            <source src="@media.Url" type="video/mp4" />
                            Your browser does not support the video tag.
                        </video>
                    }
                    else {
                        <img src="@media.Url" alt="Post media" class="post-single-media" />
                    }
                }
                else {
                    <div id="carousel-@post.PostId" class="carousel slide" data-bs-ride="false">
                        <div class="carousel-indicators">
                            @for (int i = 0; i < post.Medias.Count; i++) {
                                <button type="button" data-bs-target="#carousel-@post.PostId" data-bs-slide-to="@i" class="@(i == 0 ? "active" : "")" aria-current="@(i == 0 ? "true" : "false")" aria-label="Slide @(i + 1)"></button>
                            }
                        </div>

                        <div class="carousel-inner">
                            @for (int i = 0; i < post.Medias.Count; i++) {
                                var media = post.Medias[i];
                                <div class="carousel-item @(i == 0 ? "active" : "")">
                                    @if (media.MediaType == "video") {
                                        <video controls class="d-block w-100 carousel-media">
                                            <source src="@media.Url" type="video/mp4" />
                                            Your browser does not support the video tag.
                                        </video>
                                    }
                                    else {
                                        <img src="@media.Url" class="d-block w-100 carousel-media" alt="Post media @(i + 1)">
                                    }
                                </div>
                            }
                        </div>

                        @if (post.Medias.Count > 1) {
                            <button class="carousel-control-prev" type="button" data-bs-target="#carousel-@post.PostId" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Previous</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#carousel-@post.PostId" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Next</span>
                            </button>
                        }
                    </div>
                }
            </div>
        }

        <!-- POST ACTIONS (LIKE, COMMENT, SHARE) -->
        <div class="post-actions-section">
            <div class="post-action-buttons">
                <button class="action-btn @(post.IsLiked ? "liked" : "")" onclick="toggleLike(this, @post.PostId)" title="@(post.IsLiked ? "Unlike" : "Like")">
                    <i class="bi @(post.IsLiked ? "bi-heart-fill" : "bi-heart")"></i>
                </button>

                <a class="action-btn" asp-controller="Post" asp-action="PostDetails" asp-route-id="@post.PostId" title="Comment">
                    <i class="bi bi-chat"></i>
                </a>

                <button class="action-btn" title="Share">
                    <i class="bi bi-send"></i>
                </button>

                <button class="action-btn action-btn-save ml-auto" title="Save">
                    <i class="bi bi-bookmark"></i>
                </button>
            </div>

            <div class="post-stats">
                <p class="likes-count">
                    <span class="like-number">@post.LikeCount</span> @(post.LikeCount == 1 ? "like" : "likes")
                </p>
            </div>
        </div>

        <!-- CAPTION -->
        @if (!string.IsNullOrEmpty(post.Caption)) {
            <div class="post-caption">
                <span class="caption-username">@post.Owner.UserName</span>
                <span class="caption-text">@post.Caption</span>
            </div>
        }

        <!-- VIEW COMMENTS -->
        @if (post.CommentCount > 0) {
            <div class="post-comments-preview">
                <a asp-controller="Post" asp-action="PostDetails" asp-route-id="@post.PostId" class="view-comments-link">
                    View all @post.CommentCount @(post.CommentCount == 1 ? "comment" : "comments")
                </a>
            </div>
        }

        <!-- HASHTAGS -->
        @if (!string.IsNullOrEmpty(post.Hashtags)) {
            <div class="post-hashtags">
                @foreach (var tag in post.Hashtags.Split(' ', StringSplitOptions.RemoveEmptyEntries)) {
                    var displayTag = tag.StartsWith("#") ? tag : "#" + tag;
                    <a href="#" class="hashtag-tag" onclick="searchHashtag('@displayTag'); return false;">@displayTag</a>
                }
            </div>
        }

        <!-- POST FOOTER -->
        <div class="post-footer">
            <div class="post-time-ago">@GetTimeAgo(post.CreatedAt)</div>
        </div>
    </div>
}

@functions {
    string GetTimeAgo(DateTime createdAt) {
        var timeSpan = DateTime.Now - createdAt;

        if (timeSpan.TotalMinutes < 1)
            return "Just now";
        if (timeSpan.TotalMinutes < 60)
            return $"{(int)timeSpan.TotalMinutes}m ago";
        if (timeSpan.TotalHours < 24)
            return $"{(int)timeSpan.TotalHours}h ago";
        if (timeSpan.TotalDays < 7)
            return $"{(int)timeSpan.TotalDays}d ago";
        if (timeSpan.TotalDays < 30)
            return $"{(int)(timeSpan.TotalDays / 7)}w ago";

        return createdAt.ToString("dd MMM yyyy");
    }
}