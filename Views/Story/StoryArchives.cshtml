@model List<Mini_Social_Media.Models.ViewModel.StoryArchiveViewModel>

@{
    ViewData["Title"] = "Story Archives";
}

<div class="container py-4">
    <div class="d-flex align-items-center mb-4">
        <a href="javascript:history.back()" class="text-dark me-3 fs-4"><i class="bi bi-arrow-left"></i></a>
        <h4 class="mb-0 fw-bold">Story Archive</h4>
    </div>

    @if (!Model.Any()) {
        <div class="text-center mt-5 text-muted">
            <i class="bi bi-clock-history display-1"></i>
            <p class="mt-3">No stories archived yet.</p>
        </div>
    }
    else {
        <div class="archive-grid">
            @foreach (var item in Model) {
                <div class="archive-item" onclick="openStoryViewer(@item.StoryArchiveId, '@item.MediaUrl', '@item.MediaType', '@item.CreatedAt.ToString("dd MMM yyyy")')">

                    @if (item.MediaType == "video") {
                        <video class="archive-thumb" preload="metadata">
                            <source src="@item.MediaUrl#t=0.1" type="video/mp4">
                        </video>
                        <i class="bi bi-play-fill video-indicator"></i>
                    }
                    else {
                        <img src="@item.MediaUrl" class="archive-thumb" alt="Story archive" />
                    }

                    <div class="archive-date-overlay">
                        @item.CreatedAt.ToString("dd MMM")
                    </div>
                </div>
            }
        </div>
    }
</div>

<div class="modal fade" id="storyViewerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
        <div class="modal-content bg-black text-white" style="border-radius: 15px; overflow: hidden;">

            <div class="modal-header border-0 position-absolute w-100 p-3" style="z-index: 10; background: linear-gradient(to bottom, rgba(0,0,0,0.5), transparent);">
                <div>
                    <span class="fw-bold" id="viewerDate">Date</span>
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-light border-0 me-2" onclick="deleteCurrentArchive()">
                        <i class="bi bi-trash"></i>
                    </button>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
            </div>

            <div class="modal-body p-0 d-flex align-items-center justify-content-center bg-dark" style="min-height: 80vh;">
                <img id="viewerImage" src="" class="d-none w-100 h-100" style="object-fit: contain; max-height: 85vh;" />
                <video id="viewerVideo" controls class="d-none w-100" style="max-height: 85vh;">
                    <source src="" type="video/mp4">
                </video>
                <input type="hidden" id="currentArchiveId" />
            </div>
        </div>
    </div>
</div>

<style>
    /* CSS Grid cho Archive giống Instagram */
    .archive-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr); /* 3 cột trên mobile */
        gap: 3px;
    }

    @@media (min-width: 768px) {
        .archive-grid

    {
        grid-template-columns: repeat(4, 1fr); /* 4 cột trên tablet */
        gap: 15px;
    }

    }

    @@media (min-width: 992px) {
        .archive-grid

    {
        grid-template-columns: repeat(5, 1fr); /* 5 cột trên desktop */
    }

    }

    .archive-item {
        position: relative;
        aspect-ratio: 9 / 16; /* Tỉ lệ story chuẩn */
        background-color: #f0f0f0;
        cursor: pointer;
        overflow: hidden;
        border-radius: 4px;
    }

    .archive-thumb {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.2s;
    }

    .archive-item:hover .archive-thumb {
        transform: scale(1.05);
        opacity: 0.9;
    }

    .video-indicator {
        position: absolute;
        top: 8px;
        right: 8px;
        color: white;
        font-size: 1.2rem;
        text-shadow: 0 1px 3px rgba(0,0,0,0.5);
    }

    .archive-date-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        padding: 8px;
        background: linear-gradient(to top, rgba(0,0,0,0.6), transparent);
        color: white;
        font-size: 0.8rem;
        text-align: center;
        font-weight: 500;
    }

    /* Modal Customization */
    .bg-black {
        background-color: #000 !important;
    }
</style>

<script>
    var storyModal;

    document.addEventListener('DOMContentLoaded', function () {
        storyModal = new bootstrap.Modal(document.getElementById('storyViewerModal'));

        // Dừng video khi đóng modal
        document.getElementById('storyViewerModal').addEventListener('hidden.bs.modal', function () {
            var videoEl = document.getElementById('viewerVideo');
            videoEl.pause();
            videoEl.currentTime = 0;
        });
    });

    // 1. Hàm mở Modal xem chi tiết
    function openStoryViewer(id, url, type, date) {
        // Set dữ liệu
        document.getElementById('currentArchiveId').value = id;
        document.getElementById('viewerDate').innerText = date;

        var imgEl = document.getElementById('viewerImage');
        var videoEl = document.getElementById('viewerVideo');

        // Reset hiển thị
        imgEl.classList.add('d-none');
        videoEl.classList.add('d-none');

        if (type === 'video') {
            videoEl.src = url;
            videoEl.classList.remove('d-none');
            videoEl.play(); // Tự động phát
        } else {
            imgEl.src = url;
            imgEl.classList.remove('d-none');
        }

        storyModal.show();
    }

    // 2. Hàm xóa Archive
    async function deleteCurrentArchive() {
        if (!confirm('Delete this story from your archive?')) return;

        var archiveId = document.getElementById('currentArchiveId').value;
        var btn = event.currentTarget; // Nút delete đang bấm

        try {
            // Gọi về Controller DeleteArchive
            // Lưu ý: Controller của bạn là [HttpPost] và nhận tham số qua Query String hoặc Form
            const response = await fetch(`/Story/DeleteArchive?archiveId=${archiveId}`, {
                method: 'POST'
            });

            if (response.ok) {
                alert('Deleted successfully');
                storyModal.hide();
                location.reload(); // Tải lại trang để cập nhật lưới
            } else {
                alert('Failed to delete.');
            }
        } catch (error) {
            console.error(error);
            alert('Error connecting to server.');
        }
    }
</script>