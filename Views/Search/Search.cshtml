@using Mini_Social_Media.Models.ViewModel
@using Microsoft.AspNetCore.Identity
@using System.Security.Claims
@inject UserManager<User> UserManager
@{
    ViewData["Title"] = "Search";
    Layout = "_Layout";

    // Lấy dữ liệu từ Controller
    var users = ViewData["Users"] as IEnumerable<UserSummaryViewModel>;
    var posts = ViewData["Posts"] as List<PostViewModel>;
    var query = Context.Request.Query["searchinfo"].ToString();

    var currentUser = await UserManager.GetUserAsync(User);
    var userIdstr = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
    var currentUserId = userIdstr == null ? 0 : int.Parse(userIdstr);
}

<div class="container mt-4" style="max-width: 800px;">

    <!-- 1. THANH TÌM KIẾM -->
    <div class="row justify-content-center mb-4">
        <div class="col-md-10">
            <form asp-controller="Search" asp-action="Search" method="get" id="searchForm">
                <div class="input-group">
                    <span class="input-group-text bg-light border-end-0 rounded-start-pill ps-3">
                        <i class="bi bi-search text-muted"></i>
                    </span>
                    <input type="text" name="searchinfo" class="form-control bg-light border-start-0 rounded-end-pill shadow-none"
                           placeholder="Search" value="@query" autocomplete="off">
                </div>
            </form>
        </div>
    </div>

    @if (string.IsNullOrEmpty(query)) {
        <!-- Trạng thái chưa tìm kiếm -->
        <div class="text-center py-5 text-muted">
            <i class="bi bi-search display-1 opacity-25"></i>
            <p class="mt-3">Search for friends, hashtags, or posts.</p>
        </div>
    }
    else {
        <!-- 2. TABS CHUYỂN ĐỔI -->
        <ul class="nav nav-tabs nav-fill mb-4" id="searchTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="accounts-tab" data-bs-toggle="tab" data-bs-target="#accounts" type="button" role="tab">
                    <svg class="tab-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    <span>Accounts</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="posts-tab" data-bs-toggle="tab" data-bs-target="#posts" type="button" role="tab">
                    <svg class="tab-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    <span>Posts</span>
                </button>
            </li>
        </ul>

        <!-- 3. KẾT QUẢ TÌM KIẾM -->
        <div class="tab-content" id="searchTabsContent">

            <!-- TAB: ACCOUNTS -->
            <div class="tab-pane fade show active" id="accounts" role="tabpanel">
                @if (users != null && users.Any()) {
                    <div class="list-group list-group-flush rounded-3 border-0">
                        @foreach (var user in users) {
                            @if (user.UserId != currentUserId) {
                                <a href="/Profile/UserProfile?id=@user.UserId" class="list-group-item list-group-item-action p-3 border-0 d-flex align-items-center hover-bg-light">
                                    <img src="@(user.AvatarUrl ?? "/images/default-avatar.png")" class="rounded-circle border me-3" width="50" height="50" style="object-fit: cover;">
                                    <div class="flex-grow-1 min-w-0">
                                        <div class="fw-bold text-dark text-truncate">@user.UserName</div>
                                        <div class="text-muted small text-truncate">@user.FullName</div>
                                    </div>
                                    <span class="btn btn-sm btn-light border fw-bold">View</span>
                                </a>
                            }
                            else
                            {
                                <a href="/Profile/MyProfile" class="list-group-item list-group-item-action p-3 border-0 d-flex align-items-center hover-bg-light">
                                    <img src="@(currentUser.AvatarUrl ?? "/images/default-avatar.png")" class="rounded-circle border me-3" width="50" height="50" style="object-fit: cover;">
                                    <div class="flex-grow-1 min-w-0">
                                        <div class="fw-bold text-dark text-truncate">@currentUser.UserName</div>
                                        <div class="text-muted small text-truncate">@currentUser.FullName</div>
                                    </div>
                                    <span class="btn btn-sm btn-light border fw-bold">View</span>
                                </a>
                            }
                        }
                    </div>
                }
                else {
                    <div class="text-center py-5 text-muted">No accounts found.</div>
                }
            </div>

            <!-- TAB: POSTS -->
            <div class="tab-pane fade" id="posts" role="tabpanel">
                @if (posts != null && posts.Count > 0) {
                    <div class="row g-2">
                        @foreach (var post in posts) {
                            var isOwner = post.Owner.UserId == currentUserId;

                            <div class="post-card" data-post-id="@post.PostId">

                                <!-- POST HEADER -->
                                <div class="post-card-header">
                                    @if (currentUserId != post.Owner.UserId) {
                                        <a asp-controller="Profile" asp-action="UserProfile" asp-route-id="@post.Owner.UserId" class="post-avatar-link">
                                            <img src="@post.Owner.AvatarUrl" class="post-user-avatar" alt="@post.Owner.UserName" />
                                        </a>
                                    }
                                    else {
                                        <a asp-controller="Profile" asp-action="MyProfile" class="post-avatar-link">
                                            <img src="@post.Owner.AvatarUrl" class="post-user-avatar" alt="@post.Owner.UserName" />
                                        </a>
                                    }

                                    <div class="post-user-details">
                                        @if (currentUserId != post.Owner.UserId) {
                                            <a asp-controller="Profile" asp-action="UserProfile" asp-route-id="@post.Owner.UserId" class="post-username-link">
                                                <h5 class="post-username">@post.Owner.UserName</h5>
                                            </a>
                                        }
                                        else {
                                            <a asp-controller="Profile" asp-action="MyProfile" class="post-username-link">
                                                <h5 class="post-username">@post.Owner.UserName</h5>
                                            </a>
                                        }

                                        @if (!string.IsNullOrEmpty(post.Location)) {
                                            <p class="post-location">
                                                <i class="bi bi-geo-alt-fill"></i> @post.Location
                                            </p>
                                        }
                                    </div>

                                    <div class="post-header-right">
                                        <div class="post-timestamp">@post.CreatedAt.ToString("dd/MM/yyyy HH:mm")</div>

                                        <div class="post-dropdown">
                                            <button class="post-menu-btn" onclick="togglePostMenu(this, @post.PostId, @isOwner.ToString().ToLower())">
                                                <i class="bi bi-three-dots"></i>
                                            </button>

                                            <div class="post-dropdown-menu">
                                                @if (post.Owner.UserId == currentUserId) {
                                                    <button class="dropdown-item-custom" onclick="goToEditPost(@post.PostId)">
                                                        <i class="bi bi-pencil"></i>
                                                        Edit Post
                                                    </button>
                                                    <button class="dropdown-item-custom danger" onclick="confirmDeletePost(@post.PostId)">
                                                        <i class="bi bi-trash"></i>
                                                        Delete Post
                                                    </button>
                                                }
                                                else {
                                                    <a class="dropdown-item-custom" asp-controller="Post" asp-action="PostDetails" asp-route-id="@post.PostId">
                                                        <i class="bi bi-eye"></i>
                                                        View Details
                                                    </a>
                                                    <button class="dropdown-item-custom danger" onclick="openReportModal(@post.PostId)">
                                                        <i class="bi bi-flag me-2"></i> Report
                                                    </button>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- MEDIA -->
                                @if (post.Medias != null && post.Medias.Any()) {
                                    <div class="post-media-section">
                                        @if (post.Medias.Count == 1) {
                                            var media = post.Medias.First();
                                            @if (media.MediaType == "video") {
                                                <video controls class="post-single-media">
                                                    <source src="@media.Url" type="video/mp4" />
                                                    Your browser does not support the video tag.
                                                </video>
                                            }
                                            else {
                                                <img src="@media.Url" alt="Post media" class="post-single-media" />
                                            }
                                        }
                                        else {
                                            <div id="carousel-@post.PostId" class="carousel slide" data-bs-ride="false">
                                                <div class="carousel-indicators">
                                                    @for (int i = 0; i < post.Medias.Count; i++) {
                                                        <button type="button" data-bs-target="#carousel-@post.PostId" data-bs-slide-to="@i" class="@(i == 0 ? "active" : "")" aria-current="@(i == 0 ? "true" : "false")" aria-label="Slide @(i + 1)"></button>
                                                    }
                                                </div>

                                                <div class="carousel-inner">
                                                    @for (int i = 0; i < post.Medias.Count; i++) {
                                                        var media = post.Medias[i];
                                                        <div class="carousel-item @(i == 0 ? "active" : "")">
                                                            @if (media.MediaType == "video") {
                                                                <video controls class="d-block w-100 carousel-media">
                                                                    <source src="@media.Url" type="video/mp4" />
                                                                    Your browser does not support the video tag.
                                                                </video>
                                                            }
                                                            else {
                                                                <img src="@media.Url" class="d-block w-100 carousel-media" alt="Post media @(i + 1)">
                                                            }
                                                        </div>
                                                    }
                                                </div>

                                                @if (post.Medias.Count > 1) {
                                                    <button class="carousel-control-prev" type="button" data-bs-target="#carousel-@post.PostId" data-bs-slide="prev">
                                                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                                        <span class="visually-hidden">Previous</span>
                                                    </button>
                                                    <button class="carousel-control-next" type="button" data-bs-target="#carousel-@post.PostId" data-bs-slide="next">
                                                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                                        <span class="visually-hidden">Next</span>
                                                    </button>
                                                }
                                            </div>
                                        }
                                    </div>
                                }

                                <div class="post-actions-section">
                                    <div class="post-action-buttons">
                                        <button class="action-btn @(post.IsLiked ? "liked" : "")" onclick="toggleLike(this, @post.PostId)" title="@(post.IsLiked ? "Unlike" : "Like")">
                                            <i class="bi @(post.IsLiked ? "bi-heart-fill" : "bi-heart")"></i>
                                        </button>

                                        <a class="action-btn" asp-controller="Post" asp-action="PostDetails" asp-route-id="@post.PostId" title="Comment">
                                            <i class="bi bi-chat"></i>
                                        </a>

                                        <button class="action-btn" title="Share">
                                            <i class="bi bi-send"></i>
                                        </button>

                                        <button class="action-btn action-btn-save ml-auto" title="Save">
                                            <i class="bi bi-bookmark"></i>
                                        </button>
                                    </div>

                                    <div class="post-stats">
                                        <p class="likes-count">
                                            <span class="like-number">@post.LikeCount</span> @(post.LikeCount == 1 ? "like" : "likes")
                                        </p>
                                    </div>
                                </div>

                                @if (!string.IsNullOrEmpty(post.Caption)) {
                                    <div class="post-caption">
                                        <span class="caption-username">@post.Owner.UserName</span>
                                        <span class="caption-text">@post.Caption</span>
                                    </div>
                                }

                                @if (post.CommentCount > 0) {
                                    <div class="post-comments-preview">
                                        <a asp-controller="Post" asp-action="PostDetails" asp-route-id="@post.PostId" class="view-comments-link">
                                            View all @post.CommentCount @(post.CommentCount == 1 ? "comment" : "comments")
                                        </a>
                                    </div>
                                }

                                @if (!string.IsNullOrEmpty(post.Hashtags)) {
                                    <div class="post-hashtags">
                                        @foreach (var tag in post.Hashtags.Split(' ', StringSplitOptions.RemoveEmptyEntries)) {
                                            var displayTag = tag.StartsWith("#") ? tag : "#" + tag;
                                            <a href="#" class="hashtag-tag" onclick="searchHashtag('@displayTag'); return false;">@displayTag</a>
                                        }
                                    </div>
                                }

                                <div class="post-footer">
                                    <div class="post-time-ago">@GetTimeAgo(post.CreatedAt)</div>
                                </div>
                            </div>
                        }
                        <div class="modal fade" id="reportModal" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content rounded-4 border-0 overflow-hidden">
                                    <div class="modal-header border-bottom-0 text-center py-3">
                                        <h5 class="modal-title w-100 fw-bold text-danger fs-6">Report Post</h5>
                                    </div>
                                    <div class="modal-body p-0">
                                        <input type="hidden" id="hiddenReportPostId" value="" />
                                        <div class="list-group list-group-flush text-center">
                                            <button class="list-group-item list-group-item-action py-3 text-danger fw-bold" onclick="submitReport('Spam')">It's spam</button>
                                            <button class="list-group-item list-group-item-action py-3 text-danger fw-bold" onclick="submitReport('Inappropriate')">Inappropriate content</button>
                                            <button class="list-group-item list-group-item-action py-3 text-danger fw-bold" onclick="submitReport('Hate Speech')">Hate speech or symbols</button>
                                            <button class="list-group-item list-group-item-action py-3 text-danger fw-bold" onclick="submitReport('Violence')">Violence or dangerous organizations</button>
                                            <button class="list-group-item list-group-item-action py-3" data-bs-dismiss="modal">Cancel</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
                else {
                    <div class="text-center py-5 text-muted">No posts found.</div>
                }
            </div>
        </div>
    }
</div>

<style>
    .list-group-item-action:active {
        background-color: #e8f0fe;
        color: #0d6efd;
    }

    .modal-content {
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
</style>

<script src="~/js/newfeed.js" />

@functions {
    string GetTimeAgo(DateTime createdAt) {
        var timeSpan = DateTime.Now - createdAt;

        if (timeSpan.TotalMinutes < 1)
            return "Just now";
        if (timeSpan.TotalMinutes < 60)
            return $"{(int)timeSpan.TotalMinutes}m ago";
        if (timeSpan.TotalHours < 24)
            return $"{(int)timeSpan.TotalHours}h ago";
        if (timeSpan.TotalDays < 7)
            return $"{(int)timeSpan.TotalDays}d ago";
        if (timeSpan.TotalDays < 30)
            return $"{(int)(timeSpan.TotalDays / 7)}w ago";

        return createdAt.ToString("dd MMM yyyy");
    }
}