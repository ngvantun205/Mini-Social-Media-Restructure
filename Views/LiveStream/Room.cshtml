@model Mini_Social_Media.Models.ViewModel.LiveRoomViewModel
@{
    ViewData["Title"] = Model.Title;
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@Model.Title - Live</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <style>
        body {
            background-color: #000;
            color: white;
            overflow: hidden;
            height: 100vh;
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        .live-container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        /* --- KHU VỰC VIDEO --- */
        .video-section {
            flex: 1;
            position: relative;
            background: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #video-grid {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Video element do LiveKit tạo ra */
        video {
            width: 100%;
            height: 100%;
            object-fit: contain; 
            max-height: 100vh;
        }

        /* --- NHÃN LIVE --- */
        .live-badge {
            position: absolute;
            top: 20px;
            left: 20px;
            background: #ff0000;
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-weight: 700;
            font-size: 0.9rem;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            animation: pulse 2s infinite;
        }

        @@keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* --- NÚT ĐIỀU KHIỂN --- */
        .controls-overlay {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px 20px;
            border-radius: 30px;
            backdrop-filter: blur(5px);
        }

        .control-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(1.1);
        }

        .btn-end {
            background: #dc3545 !important;
        }
        
        .btn-exit {
            background: #6c757d !important;
            text-decoration: none;
        }

        /* --- KHU VỰC CHAT --- */
        .chat-section {
            width: 350px;
            min-width: 300px;
            background: #fff;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #333;
            color: #333;
        }

        .chat-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: #fdfdfd;
        }

        .chat-input-area {
            padding: 15px;
            border-top: 1px solid #eee;
            background: #fff;
        }

        .msg-item {
            display: flex;
            font-size: 0.9rem;
            animation: fadeIn 0.3s ease;
        }
        
        @@keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .msg-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
            border: 1px solid #ddd;
        }

        .msg-content-wrapper {
            background: #f1f0f0;
            padding: 8px 12px;
            border-radius: 12px;
            border-top-left-radius: 2px;
            max-width: 100%;
        }

        .msg-user {
            font-weight: 700;
            font-size: 0.85rem;
            color: #444;
            margin-bottom: 2px;
            display: block;
        }
        
        .msg-text {
            word-wrap: break-word;
            line-height: 1.4;
        }

        /* --- OVERLAY UNMUTE (FIX LỖI MẤT TIẾNG) --- */
        #unmute-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 50;
            display: none; /* Mặc định ẩn, chỉ hiện khi browser chặn audio */
            align-items: center;
            justify-content: center;
            flex-direction: column;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div class="live-container">
        <div class="video-section">
            <div class="live-badge">LIVE</div>

            <div id="video-grid">
                <div class="text-white-50">Waiting for stream...</div>
            </div>

            <div id="unmute-overlay" onclick="enableAudioContext()">
                <div class="text-center">
                    <i class="bi bi-volume-mute-fill" style="font-size: 4rem;"></i>
                    <h4 class="mt-3">Tap to Unmute</h4>
                    <p class="small text-white-50">Browser requires interaction to play audio</p>
                </div>
            </div>

            <div class="controls-overlay">
                @if (Model.IsHost)
                {
                    <button class="control-btn" onclick="toggleMic()" title="Mute/Unmute"><i class="bi bi-mic-fill" id="icon-mic"></i></button>
                    <button class="control-btn" onclick="toggleCam()" title="Camera On/Off"><i class="bi bi-camera-video-fill" id="icon-cam"></i></button>
                    <button class="control-btn btn-end" onclick="endStream()" title="End Stream"><i class="bi bi-power"></i></button>
                }
                else
                {
                     // Nút Unmute thủ công cho Viewer
                    <button class="control-btn" id="btn-manual-unmute" onclick="enableAudioContext()" title="Unmute Audio">
                        <i class="bi bi-volume-mute-fill"></i>
                    </button>
                    <a href="/" class="control-btn btn-exit" title="Leave Room"><i class="bi bi-box-arrow-right"></i></a>
                }
            </div>
        </div>

        <div class="chat-section">
            <div class="chat-header">
                <h5 class="mb-0 text-truncate" style="max-width: 250px;">@Model.Title</h5>
                <small class="text-muted d-flex align-items-center mt-1">
                    <i class="bi bi-person-circle me-1"></i> @Model.StreamerName
                </small>
            </div>
            
            <div class="chat-messages" id="chat-box">
                <div class="text-center text-muted small mt-5">
                    <i class="bi bi-chat-dots fs-3"></i><br/>
                    Welcome to the chat room!
                </div>
            </div>
            
            <div class="chat-input-area">
                <div class="input-group">
                    <input type="text" id="msgInput" class="form-control" placeholder="Say something..." autocomplete="off">
                    <button class="btn btn-primary" onclick="sendMessage()"><i class="bi bi-send-fill"></i></button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/livekit-client/dist/livekit-client.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>

    <script>
        // --- CONFIGURATION ---
        const ROOM_ID = @Model.RoomId;
        const TOKEN = "@Model.Token";
        const LK_URL = "@Model.LiveKitUrl";
        const IS_HOST = @Model.IsHost.ToString().ToLower();

        let room; // LiveKit Room
        let chatConnection; // SignalR

        // --- 1. LIVEKIT LOGIC (VIDEO & AUDIO) ---
        async function startLiveKit() {
            // Khởi tạo Room
            room = new LivekitClient.Room({
                adaptiveStream: true,
                dynacast: true,
                videoCaptureDefaults: {
                    resolution: LivekitClient.VideoPresets.h720.resolution,
                }
            });

            // SỰ KIỆN: Khi có Track mới (Video/Audio) từ người khác
            room.on(LivekitClient.RoomEvent.TrackSubscribed, (track, publication, participant) => {
                handleTrackAttached(track, participant);
            });

            // SỰ KIỆN: Khi Track bị gỡ bỏ (Host tắt cam/mic)
            room.on(LivekitClient.RoomEvent.TrackUnsubscribed, (track, publication, participant) => {
                track.detach();
                if (track.kind === 'video') {
                    const videoGrid = document.getElementById('video-grid');
                    // Xóa video đi, hiện lại text waiting
                    if (videoGrid) videoGrid.innerHTML = '<div class="text-white-50">Stream paused...</div>';
                }
            });

            // KẾT NỐI
            try {
                await room.connect(LK_URL, TOKEN);
                console.log('✅ Connected to LiveKit Room:', room.name);

                if (IS_HOST) {
                    await startPublishing();
                } else {
                    // Viewer: Kiểm tra xem đã có track nào chưa (trường hợp vào sau)
                    room.participants.forEach(p => {
                        p.trackPublications.forEach(pub => {
                            if (pub.isSubscribed && pub.track) {
                                handleTrackAttached(pub.track, p);
                            }
                        });
                    });
                }
            } catch (error) {
                console.error('❌ Failed to connect LiveKit:', error);
                alert("Cannot connect to Live Server. Please check configuration.");
            }
        }

        async function startPublishing() {
            try {
                console.log("Requesting Camera/Mic permissions...");

                // Bước 1: Bật Cam/Mic (Không gán vào biến tracks nữa để tránh lỗi undefined)
                await room.localParticipant.enableCameraAndMicrophone();

                // Bước 2: Tìm track Video trong danh sách đã publish
                // Lưu ý: videoTracks là một Map, ta cần lấy values() rồi chuyển thành Array
                let videoTrack = null;

                // Kiểm tra an toàn: Có localParticipant và có videoTracks
                if (room.localParticipant && room.localParticipant.videoTracks) {
                    const publications = Array.from(room.localParticipant.videoTracks.values());

                    if (publications.length > 0) {
                        // Lấy track từ publication đầu tiên
                        videoTrack = publications[0].track;
                    }
                }

                // Bước 3: Nếu chưa thấy track (do độ trễ), thử lấy trực tiếp từ Camera (fallback)
                if (!videoTrack) {
                    console.warn("⚠️ Track not found in Map, trying generic create...");
                    // Cách này ép tạo track mới nếu ở trên không tìm thấy
                    const tracks = await LivekitClient.createLocalTracks({ audio: true, video: true });
                    const vTrack = tracks.find(t => t.kind === 'video');
                    if (vTrack) {
                        await room.localParticipant.publishTrack(vTrack);
                        videoTrack = vTrack;
                    }
                }

                // Bước 4: Hiển thị
                if (videoTrack) {
                    attachVideoElement(videoTrack);

                    // Lật ngược video gương (cho đẹp)
                    const videoEl = document.getElementById('video-grid').querySelector('video');
                    if(videoEl) videoEl.style.transform = "scaleX(-1)";

                    console.log("🎤 📷 Host is live!");
                } else {
                    console.error("❌ Camera enabled but could not retrieve Video Track.");
                    alert("Camera error: Device active but no video signal.");
                }

            } catch (err) {
                console.error("Publish Error Detail:", err);
                alert("Lỗi truy cập Camera: " + (err.message || err));
            }
        }

        // Hàm xử lý chung khi nhận Track (Video hoặc Audio)
        function handleTrackAttached(track, participant) {
            if (track.kind === 'video') {
                attachVideoElement(track);
            } 
            else if (track.kind === 'audio') {
                // Nếu là Host thì KHÔNG nghe tiếng của chính mình
                if (participant.identity === room.localParticipant.identity) return;

                const audioElement = track.attach();
                document.body.appendChild(audioElement);

                // Cố gắng chạy Audio ngay lập tức
                audioElement.play().catch(error => {
                    console.warn("⚠️ Autoplay blocked by browser. Showing unmute overlay.");
                    // Nếu lỗi (do chưa tương tác), hiện overlay bắt người dùng click
                    document.getElementById('unmute-overlay').style.display = 'flex';
                });
            }
        }

        // Hàm gắn Video vào HTML
        function attachVideoElement(track) {
            const videoElement = track.attach();
            const grid = document.getElementById('video-grid');
            grid.innerHTML = ''; // Xóa nội dung cũ (Waiting text)
            grid.appendChild(videoElement);
        }

        // --- 2. AUDIO HANDLING (FIX LỖI MẤT TIẾNG) ---
        // Hàm này được gọi khi bấm vào Overlay hoặc nút Unmute
        function enableAudioContext() {
            const audioElements = document.querySelectorAll('audio');
            
            // Duyệt qua tất cả audio đang có và ép chạy
            audioElements.forEach(audio => {
                audio.muted = false;
                audio.play()
                    .then(() => {
                        console.log("Audio playing...");
                    })
                    .catch(e => console.error("Audio play failed:", e));
            });

            // Ẩn Overlay
            document.getElementById('unmute-overlay').style.display = 'none';
            
            // Đổi icon nút manual unmute thành volume up
            const btn = document.getElementById('btn-manual-unmute');
            if(btn) btn.innerHTML = '<i class="bi bi-volume-up-fill"></i>';
        }

        // --- 3. SIGNALR LOGIC (CHAT) ---
        async function startSignalR() {
            chatConnection = new signalR.HubConnectionBuilder()
                .withUrl("/hubs/livestream")
                .withAutomaticReconnect()
                .build();

            chatConnection.on("ReceiveLiveMessage", (msg) => {
                renderMessage(msg);
            });

            try {
                await chatConnection.start();
                await chatConnection.invoke("JoinLiveGroup", "live_" + ROOM_ID);
                loadHistory(); // Load tin nhắn cũ
            } catch (err) {
                console.error("SignalR Error:", err);
            }
        }

        async function loadHistory() {
            try {
                const res = await fetch(`/api/LiveStream/${ROOM_ID}/messages`);
                if(res.ok) {
                    const msgs = await res.json();
                    const box = document.getElementById('chat-box');
                    if(msgs.length > 0) box.innerHTML = ''; // Clear welcome text only if history exists
                    msgs.forEach(m => renderMessage(m));
                }
            } catch(e) { console.error(e); }
        }

        function renderMessage(msg) {
            const box = document.getElementById('chat-box');
            
            // Format time
            const date = new Date(msg.sentAt);
            const timeStr = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

            const div = document.createElement('div');
            div.className = 'msg-item';
            div.innerHTML = `
                <img src="${msg.userAvatar || '/images/default-avatar.png'}" class="msg-avatar" onerror="this.src='https://via.placeholder.com/32'">
                <div class="msg-content-wrapper">
                    <span class="msg-user">${msg.userName} <small class="text-muted fw-normal ms-1" style="font-size:0.7em">${timeStr}</small></span>
                    <div class="msg-text">${msg.content}</div>
                </div>
            `;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('msgInput');
            const content = input.value.trim();
            if (!content) return;

            try {
                const res = await fetch(`/api/LiveStream/${ROOM_ID}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: content })
                });

                if(res.ok) input.value = '';
                else console.error('Chat failed');
            } catch(err) {
                console.error(err);
            }
        }

        // --- 4. HOST CONTROLS ---
        let isMicOn = true;
        let isCamOn = true;

        async function toggleMic() {
            if(!room || !room.localParticipant) return;
            isMicOn = !isMicOn;
            await room.localParticipant.setMicrophoneEnabled(isMicOn);
            document.getElementById('icon-mic').className = isMicOn ? "bi bi-mic-fill" : "bi bi-mic-mute-fill";
            document.getElementById('icon-mic').parentElement.style.background = isMicOn ? "" : "#dc3545"; // Đổi màu đỏ khi tắt
        }

        async function toggleCam() {
            if(!room || !room.localParticipant) return;
            isCamOn = !isCamOn;
            await room.localParticipant.setCameraEnabled(isCamOn);
            document.getElementById('icon-cam').className = isCamOn ? "bi bi-camera-video-fill" : "bi bi-camera-video-off-fill";
            document.getElementById('icon-cam').parentElement.style.background = isCamOn ? "" : "#dc3545";
        }

        async function endStream() {
            if(!confirm("Are you sure you want to end this stream?")) return;
            
            // Ngắt kết nối LiveKit
            if(room) room.disconnect();

            // Gọi API báo server kết thúc
            await fetch(`/LiveStream/EndLiveStream?roomId=${ROOM_ID}`, { method: 'POST' });
            window.location.href = "/";
        }

        // --- EVENTS ---
        document.getElementById('msgInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        document.addEventListener("DOMContentLoaded", () => {
            startLiveKit();
            startSignalR();
        });

        window.addEventListener("beforeunload", () => {
            if(room) room.disconnect();
            if(chatConnection) chatConnection.stop();
        });

    </script>
</body>
</html>