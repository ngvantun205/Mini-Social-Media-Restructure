@model Mini_Social_Media.Models.ViewModel.LiveRoomViewModel
@{
    ViewData["Title"] = Model.Title;
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@Model.Title - Live</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <style>
        body {
            background-color: #000;
            color: white;
            overflow: hidden;
            height: 100vh;
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        .live-container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        /* --- KHU VỰC VIDEO --- */
        .video-section {
            flex: 1;
            position: relative;
            background: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #video-grid {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Video element do LiveKit tạo ra */
        video {
            width: 100%;
            height: 100%;
            object-fit: contain; 
            max-height: 100vh;
        }

        /* --- NHÃN LIVE --- */
        .live-badge {
            position: absolute;
            top: 20px;
            left: 20px;
            background: #ff0000;
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-weight: 700;
            font-size: 0.9rem;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            animation: pulse 2s infinite;
        }

        @@keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* --- NÚT ĐIỀU KHIỂN --- */
        .controls-overlay {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px 20px;
            border-radius: 30px;
            backdrop-filter: blur(5px);
        }

        .control-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(1.1);
        }

        .btn-end {
            background: #dc3545 !important;
        }
        
        .btn-exit {
            background: #6c757d !important;
            text-decoration: none;
        }

        /* --- KHU VỰC CHAT --- */
        .chat-section {
            width: 350px;
            min-width: 300px;
            background: #fff;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #333;
            color: #333;
        }

        .chat-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: #fdfdfd;
        }

        .chat-input-area {
            padding: 15px;
            border-top: 1px solid #eee;
            background: #fff;
        }

        .msg-item {
            display: flex;
            font-size: 0.9rem;
            animation: fadeIn 0.3s ease;
        }
        
        @@keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .msg-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
            border: 1px solid #ddd;
        }

        .msg-content-wrapper {
            background: #f1f0f0;
            padding: 8px 12px;
            border-radius: 12px;
            border-top-left-radius: 2px;
            max-width: 100%;
        }

        .msg-user {
            font-weight: 700;
            font-size: 0.85rem;
            color: #444;
            margin-bottom: 2px;
            display: block;
        }
        
        .msg-text {
            word-wrap: break-word;
            line-height: 1.4;
        }

        /* --- OVERLAY UNMUTE (FIX LỖI MẤT TIẾNG) --- */
        #unmute-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 50;
            display: none; /* Mặc định ẩn, chỉ hiện khi browser chặn audio */
            align-items: center;
            justify-content: center;
            flex-direction: column;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div class="live-container">
        <div class="video-section">
            <div class="live-badge">LIVE</div>

            <div id="video-grid">
                <div class="text-white-50">Waiting for stream...</div>
            </div>

            <div id="unmute-overlay" onclick="enableAudioContext()">
                <div class="text-center">
                    <i class="bi bi-volume-mute-fill" style="font-size: 4rem;"></i>
                    <h4 class="mt-3">Tap to Unmute</h4>
                    <p class="small text-white-50">Browser requires interaction to play audio</p>
                </div>
            </div>

            <div class="controls-overlay">
                @if (Model.IsHost)
                {
                    <button class="control-btn" onclick="toggleMic()" title="Mute/Unmute"><i class="bi bi-mic-fill" id="icon-mic"></i></button>
                    <button class="control-btn" onclick="toggleCam()" title="Camera On/Off"><i class="bi bi-camera-video-fill" id="icon-cam"></i></button>
                    <button class="control-btn btn-end" onclick="endStream()" title="End Stream"><i class="bi bi-power"></i></button>
                }
                else
                {
                     // Nút Unmute thủ công cho Viewer
                    <button class="control-btn" id="btn-manual-unmute" onclick="enableAudioContext()" title="Unmute Audio">
                        <i class="bi bi-volume-mute-fill"></i>
                    </button>
                    <a href="/" class="control-btn btn-exit" title="Leave Room"><i class="bi bi-box-arrow-right"></i></a>
                }
            </div>
        </div>

        <div class="chat-section">
            <div class="chat-header">
                <h5 class="mb-0 text-truncate" style="max-width: 250px;">@Model.Title</h5>
                <small class="text-muted d-flex align-items-center mt-1">
                    <i class="bi bi-person-circle me-1"></i> @Model.StreamerName
                </small>
            </div>

            <div class="chat-messages" id="chat-box">
                <div class="text-center text-muted small mt-5">
                    <i class="bi bi-chat-dots fs-3"></i><br />
                    Waiting for messages...
                </div>
            </div>

            <div class="chat-input-area">
                <div class="input-group">
                    <input type="text" id="msgInput" class="form-control" placeholder="Type a message..." autocomplete="off">
                    <button class="btn btn-primary" onclick="sendChatMessage()">
                        <i class="bi bi-send-fill"></i>
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/livekit-client/dist/livekit-client.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>

    <script>
        const ROOM_ID = @Model.RoomId;
        const TOKEN = "@Model.Token";
        const LK_URL = "@Model.LiveKitUrl";
        const IS_HOST = @Model.IsHost.ToString().ToLower();

        const CHAT_API_BASE = `/api/LiveStream/${ROOM_ID}`;

        let room;     
        let chatConnection; 

        async function startLiveKit() {
            room = new LivekitClient.Room({
                adaptiveStream: true,
                dynacast: true,
                videoCaptureDefaults: { resolution: LivekitClient.VideoPresets.h720.resolution }
            });

            room.on(LivekitClient.RoomEvent.TrackSubscribed, handleTrackAttached);
            room.on(LivekitClient.RoomEvent.TrackUnsubscribed, (track) => {
                track.detach();
                if (track.kind === 'video') document.getElementById('video-grid').innerHTML = '<div class="text-white-50">Stream paused...</div>';
            });

            try {
                await room.connect(LK_URL, TOKEN);
                console.log('✅ Connected to LiveKit');
                if (IS_HOST) {
                    await startPublishing();
                } else {
                    room.participants.forEach(p => {
                        p.trackPublications.forEach(pub => { if (pub.isSubscribed && pub.track) handleTrackAttached(pub.track, p); });
                    });
                }
            } catch (error) {
                console.error('❌ LiveKit Error:', error);
                alert("Cannot connect to Live Server.");
            }
        }

        async function startPublishing() {
            try {
                console.log("Requesting Permissions...");
                await room.localParticipant.enableCameraAndMicrophone();

                let videoTrack = null;
                if (room.localParticipant?.videoTracks) {
                    const pubs = Array.from(room.localParticipant.videoTracks.values());
                    if (pubs.length > 0) videoTrack = pubs[0].track;
                }

                if (!videoTrack) {
                    const tracks = await LivekitClient.createLocalTracks({ audio: true, video: true });
                    const vTrack = tracks.find(t => t.kind === 'video');
                    if (vTrack) {
                        await room.localParticipant.publishTrack(vTrack);
                        videoTrack = vTrack;
                    }
                }

                if (videoTrack) {
                    attachVideoElement(videoTrack);
                    const videoEl = document.querySelector('#video-grid video');
                    if(videoEl) videoEl.style.transform = "scaleX(-1)";
                    console.log("🎤 📷 Host is live!");
                }
            } catch (err) {
                console.error("Publish Error:", err);
                alert("Lỗi Camera: " + err.message);
            }
        }

        function handleTrackAttached(track, participant) {
            if (track.kind === 'video') {
                attachVideoElement(track);
            } else if (track.kind === 'audio') {
                if (participant.identity === room.localParticipant.identity) return;
                const audioEl = track.attach();
                document.body.appendChild(audioEl);
                audioEl.play().catch(() => document.getElementById('unmute-overlay').style.display = 'flex');
            }
        }

        function attachVideoElement(track) {
            const el = track.attach();
            const grid = document.getElementById('video-grid');
            grid.innerHTML = '';
            grid.appendChild(el);
        }

        function enableAudioContext() {
            document.querySelectorAll('audio').forEach(a => { a.muted = false; a.play().catch(console.error); });
            document.getElementById('unmute-overlay').style.display = 'none';
            const btn = document.getElementById('btn-manual-unmute');
            if(btn) btn.innerHTML = '<i class="bi bi-volume-up-fill"></i>';
        }

        let isMicOn = true, isCamOn = true;
        async function toggleMic() {
            if(!room?.localParticipant) return;
            isMicOn = !isMicOn;
            await room.localParticipant.setMicrophoneEnabled(isMicOn);
            const icon = document.getElementById('icon-mic');
            icon.className = isMicOn ? "bi bi-mic-fill" : "bi bi-mic-mute-fill";
            icon.parentElement.style.background = isMicOn ? "" : "#dc3545";
        }
        async function toggleCam() {
            if(!room?.localParticipant) return;
            isCamOn = !isCamOn;
            await room.localParticipant.setCameraEnabled(isCamOn);
            const icon = document.getElementById('icon-cam');
            icon.className = isCamOn ? "bi bi-camera-video-fill" : "bi bi-camera-video-off-fill";
            icon.parentElement.style.background = isCamOn ? "" : "#dc3545";
        }
        async function endStream() {
            if(!confirm("End stream?")) return;
            if(room) room.disconnect();
            await fetch(`/LiveStream/EndLiveStream?roomId=${ROOM_ID}`, { method: 'POST' });
            window.location.href = "/";
        }

        async function startChatSystem() {
            if (chatConnection && chatConnection.state === signalR.HubConnectionState.Connected) return;

            chatConnection = new signalR.HubConnectionBuilder()
                .withUrl("/hubs/livestream")
                .withAutomaticReconnect()
                .build();

            chatConnection.on("ReceiveLiveMessage", (msg) => {
                renderMessage(msg);
            });

            try {
                await chatConnection.start();
                await chatConnection.invoke("JoinLiveGroup", "live_" + ROOM_ID);
                console.log("✅ Chat System Ready");
                loadOldMessages();
            } catch (err) {
                console.error("❌ Chat Connection Failed:", err);
            }
        }

        async function loadOldMessages() {
            try {
                const res = await fetch(`${CHAT_API_BASE}/messages`);
                if (res.ok) {
                    const messages = await res.json();
                    const box = document.getElementById('chat-box');
                    if (messages.length > 0) box.innerHTML = '';
                    messages.forEach(renderMessage);
                }
            } catch (e) { console.error("History Error", e); }
        }

        async function sendChatMessage() {
            const input = document.getElementById('msgInput');
            const content = input.value.trim();
            if (!content) return;

            try {
                const res = await fetch(`${CHAT_API_BASE}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: content })
                });

                if (res.ok) {
                    input.value = '';
                }
            } catch (e) { console.error("Send Error", e); }
        }

        function renderMessage(msg) {
            if (msg.id && document.getElementById(`msg-${msg.id}`)) {
                return;
            }

            const box = document.getElementById('chat-box');
            const timeStr = new Date(msg.sentAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

            const div = document.createElement('div');
            div.className = 'msg-item';
            if(msg.id) div.id = `msg-${msg.id}`;

            div.innerHTML = `
                <img src="${msg.userAvatar || '/images/default-avatar.png'}" class="msg-avatar" onerror="this.src='https://via.placeholder.com/32'">
                <div class="msg-content-wrapper">
                    <span class="msg-user">${msg.userName} <small class="text-muted fw-normal ms-1" style="font-size:0.7em">${timeStr}</small></span>
                    <div class="msg-text">${msg.content}</div>
                </div>
            `;

            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }
        const msgInput = document.getElementById('msgInput');
        if (msgInput) {
            msgInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') sendChatMessage();
            });
        }

        document.addEventListener("DOMContentLoaded", () => {
            startLiveKit();
            startChatSystem();
        });

        window.addEventListener("beforeunload", () => {
            if(room) room.disconnect();
            if(chatConnection) chatConnection.stop();
        });
    </script>
</body>
</html>