@model PostViewModel
@{
    Layout = "_Layout";
    ViewData["Title"] = "Post Detail";

    var currentUserIdStr = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
    var currentUserId = string.IsNullOrEmpty(currentUserIdStr) ? 0 : int.Parse(currentUserIdStr);
}

@functions {
    public void RenderCommentItem(CommentViewModel comment, int currentUserId, bool isReply) {
        var divId = $"comment-wrapper-{comment.CommentId}";
        var textId = $"comment-text-{comment.CommentId}";
        var safeContent = System.Web.HttpUtility.JavaScriptStringEncode(comment.Content);
        var indentClass = isReply ? "reply-comment" : "";

        <div class="comment-item @indentClass" id="@divId">
            <div class="d-flex gap-2">
                <img src="@comment.Owner.AvatarUrl" class="comment-avatar" alt="@comment.Owner.UserName">

                <div class="flex-grow-1">
                    <div class="comment-bubble">
                        <strong class="comment-username">@comment.Owner.UserName</strong>
                        <p class="comment-text mb-0" id="@textId">@comment.Content</p>
                    </div>

                    <div class="comment-actions">
                        <button class="comment-action-btn" onclick="likeComment(@comment.CommentId)">Like</button>
                        <button class="comment-action-btn" onclick="prepareReply(@comment.CommentId, '@comment.Owner.UserName', '@safeContent')">Reply</button>
                        <span class="comment-timestamp">@comment.CreatedAt.ToString("HH:mm")</span>

                        <div class="comment-dropdown d-inline">
                            <button class="dropdown-toggle-btn" type="button">
                                <i class="bi bi-three-dots"></i>
                            </button>
                            <div class="dropdown-menu">
                                @if (comment.Owner.UserId == currentUserId) {
                                    <a class="dropdown-item" href="javascript:void(0)" onclick="event.stopPropagation(); prepareEdit(@comment.CommentId, '@safeContent')">
                                        <i class="bi bi-pencil me-2"></i>Edit
                                    </a>
                                    <a class="dropdown-item text-danger" href="javascript:void(0)" onclick="event.stopPropagation(); deleteComment(@comment.CommentId)">
                                        <i class="bi bi-trash me-2"></i>Delete
                                    </a>
                                }
                                else {
                                    <a class="dropdown-item" href="javascript:void(0)" onclick="event.stopPropagation();">
                                        <i class="bi bi-flag me-2"></i>Report
                                    </a>
                                }
                            </div>
                        </div>
                    </div>

                    @if (comment.ReplyCount > 0) {
                        <div class="mt-1">
                            <a href="javascript:void(0)" class="view-replies-btn"
                               id="btn-view-replies-@comment.CommentId"
                               onclick="loadReplies(@comment.CommentId)">
                                <i class="bi bi-arrow-return-right me-1"></i>View @comment.ReplyCount @(comment.ReplyCount > 1 ? "replies" : "reply")
                            </a>
                        </div>
                        <div id="replies-container-@comment.CommentId" style="display: none;"></div>
                    }
                </div>
            </div>
        </div>
    }
}

<div class="post-detail-container">
    <div class="card post-card border-0">

        <!-- HEADER -->
        <div class="post-header">
            <img src="@Model.Owner.AvatarUrl" class="post-avatar" alt="@Model.Owner.UserName">
            <div class="post-user-info flex-grow-1">
                <h6>@Model.Owner.UserName</h6>
                @if (!string.IsNullOrEmpty(Model.Location)) {
                    <p class="post-location">@Model.Location</p>
                }
            </div>
            @if (User.Identity.IsAuthenticated && Model.Owner.UserId == currentUserId) {
                <div class="d-flex gap-2">
                    <a asp-action="EditPost" asp-route-postId="@Model.PostId" class="post-actions-btn">
                        <i class="bi bi-pencil"></i>
                    </a>
                    <button onclick="confirmDeletePost(@Model.PostId)" class="post-actions-btn delete-btn">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            }
        </div>

        <!-- CAPTION -->
        @if (!string.IsNullOrEmpty(Model.Caption)) {
            <div class="post-caption">
                <p>@Model.Caption</p>
                @if (!string.IsNullOrEmpty(Model.Hashtags)) {
                    <div class="mb-2">
                        @foreach (var tag in Model.Hashtags.Split(' ', StringSplitOptions.RemoveEmptyEntries)) {
                            <a href="#" class="hashtag-link me-1">@tag</a>
                        }
                    </div>
                }
                <p class="post-timestamp">@Model.CreatedAt.ToString("d MMMM, yyyy • HH:mm")</p>
            </div>
        }

        <!-- MEDIA -->
        @if (Model.Medias != null && Model.Medias.Any()) {
            <div class="media-container">
                @if (Model.Medias.Count() == 1) {
                    var media = Model.Medias.First();
                    if (media.MediaType == "video") {
                        <video controls class="w-100">
                            <source src="@media.Url" type="video/mp4" />
                        </video>
                    }
                    else {
                        <img src="@media.Url" class="w-100" alt="Post media" />
                    }
                }
                else {
                    <div id="carouselPost" class="carousel slide w-100" data-bs-ride="carousel">
                        <div class="carousel-inner">
                            @for (int i = 0; i < Model.Medias.Count(); i++) {
                                var media = Model.Medias.ElementAt(i);
                                <div class="carousel-item @(i == 0 ? "active" : "")">
                                    @if (media.MediaType == "video") {
                                        <video controls class="d-block w-100">
                                            <source src="@media.Url" type="video/mp4" />
                                        </video>
                                    }
                                    else {
                                        <img src="@media.Url" class="d-block w-100" alt="Post media" />
                                    }
                                </div>
                            }
                        </div>
                        <button class="carousel-control-prev" type="button" data-bs-target="#carouselPost" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon"></span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#carouselPost" data-bs-slide="next">
                            <span class="carousel-control-next-icon"></span>
                        </button>
                    </div>
                }
            </div>
        }

        <!-- POST FOOTER (INTERACTIONS) -->
        <div class="post-footer">
            <div class="interaction-icons mb-2">
                <div class="d-flex gap-2">
                    <button class="icon-btn @(Model.IsLiked ? "liked" : "")" onclick="toggleLike(this, @Model.PostId)">
                        <i class="bi @(Model.IsLiked ? "bi-heart-fill text-danger" : "bi-heart")"></i>
                    </button>
                    <button class="icon-btn">
                        <i class="bi bi-chat"></i>
                    </button>
                    <button class="icon-btn">
                        <i class="bi bi-send"></i>
                    </button>
                </div>
                <button class="icon-btn ms-auto">
                    <i class="bi bi-bookmark"></i>
                </button>
            </div>
            <p class="likes-count">@Model.LikeCount @(Model.LikeCount == 1 ? "like" : "likes")</p>
        </div>

        <!-- COMMENTS SECTION -->
        <div class="comments-section">
            <div id="commentList" class="comment-list">
                @if (Model.Comments != null && Model.Comments.Any()) {
                    var rootComments = Model.Comments.Where(c => c.ParentCommentId == null).ToList();
                    foreach (var comment in rootComments) {
                        RenderCommentItem(comment, currentUserId, false);
                    }
                }
                else {
                    <div class="no-comments">No comments yet. Be the first to comment!</div>
                }
            </div>

            <!-- COMMENT INPUT -->
            <div class="comment-input-wrapper">
                <div id="actionPreview" class="action-preview" style="display: none;">
                    <div class="d-flex align-items-center gap-2 flex-grow-1" style="min-width: 0;">
                        <strong id="actionLabel" class="action-label text-nowrap"></strong>
                        <span id="actionContentPreview" class="action-content-preview"></span>
                    </div>
                    <button type="button" class="btn-close-action" onclick="cancelAction()">
                        <i class="bi bi-x"></i>
                    </button>
                </div>

                <div class="comment-input-container" id="inputContainer">
                    <input type="hidden" id="commentPostId" value="@Model.PostId" />
                    <input type="hidden" id="parentCommentId" value="" />
                    <input type="hidden" id="editCommentId" value="" />
                    <input type="text" id="commentContent" class="comment-input" placeholder="Add a comment..." />
                    <button class="btn-post-comment" onclick="submitAction()">Post</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- DELETE POST FORM -->
<form asp-action="DeletePost" method="post" id="deleteForm" style="display: none;">
    <input type="hidden" name="postId" id="deletePostId" value="@Model.PostId" />
</form>


<input type="hidden" id="loggedInUserId" value="@currentUserId" />

@section Scripts {
    <script src="~/js/post-detail.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const userIdElement = document.getElementById('loggedInUserId');
            const userId = userIdElement ? parseInt(userIdElement.value) : 0;

            initializePostDetail(userId);
        });
    </script>
}