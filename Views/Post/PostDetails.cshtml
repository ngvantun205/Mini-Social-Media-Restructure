@model PostViewModel
@{
    Layout = "_Layout";
    ViewData["Title"] = "Post Detail";
}

<div class="container" style="max-width: 900px; margin-top: 20px; height: 85vh;">
    <div class="post-detail-card" style="background: white; border: 1px solid #dbdbdb; border-radius: 3px; display: flex; height: 100%;">

        <div class="post-media-section" style="flex: 1; background: black; display: flex; align-items: center; justify-content: center; border-right: 1px solid #efefef; overflow: hidden;">
            @if (Model.Medias != null && Model.Medias.Any()) {
                if (Model.Medias.Count() == 1) {
                    var media = Model.Medias.First();
                    if (media.MediaType == "video") {
                        <video controls style="max-width: 100%; max-height: 100%;"><source src="@media.Url" type="video/mp4" /></video>
                    } else {
                        <img src="@media.Url" style="max-width: 100%; max-height: 100%; object-fit: contain;" />
                    }
                } else {
                    <div id="carouselDetail" class="carousel slide" data-bs-ride="carousel" style="width:100%">
                        <div class="carousel-inner">
                            @for (int i = 0; i < Model.Medias.Count(); i++) {
                                var media = Model.Medias.ElementAt(i);
                                <div class="carousel-item @(i == 0 ? "active" : "")">
                                    @if (media.MediaType == "video") {
                                        <video controls class="d-block w-100" style="max-height: 85vh;"><source src="@media.Url" type="video/mp4" /></video>
                                    } else {
                                        <img src="@media.Url" class="d-block w-100" style="max-height: 85vh; object-fit: contain;" />
                                    }
                                </div>
                            }
                        </div>
                        <button class="carousel-control-prev" type="button" data-bs-target="#carouselDetail" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#carouselDetail" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        </button>
                    </div>
                }
            } else {
                <div class="text-white">No Media</div>
            }
        </div>

        <div class="post-info-section" style="width: 350px; display: flex; flex-direction: column; background: #fff;">

            <div class="post-header d-flex align-items-center p-3 border-bottom">
                <img src="/images/avatar.png" width="32" height="32" class="rounded-circle me-2" style="object-fit: cover;">
                
                <div style="flex-grow: 1; min-width: 0;">
                    <h6 class="m-0 fw-bold text-truncate">@Model.UserName</h6>
                    @if (!string.IsNullOrEmpty(Model.Location)) {
                        <small class="text-muted d-block text-truncate" style="font-size: 11px;">@Model.Location</small>
                    }
                </div>

                @if (User.Identity.IsAuthenticated && Model.UserId == int.Parse(User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier).Value)) {
                    <div class="ms-2 d-flex align-items-center gap-1">
                        <a asp-action="EditPost" asp-route-postId="@Model.PostId" class="btn btn-sm btn-light text-secondary" title="Edit Post">
                            <i class="bi bi-pencil-square"></i>
                        </a>
                        <button onclick="confirmDelete(@Model.PostId)" class="btn btn-sm btn-light text-danger" title="Delete Post">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                }
            </div>

            <div class="comments-area flex-grow-1 p-3" style="overflow-y: auto;">
                
                @if (!string.IsNullOrEmpty(Model.Caption)) {
                    <div class="caption-section mb-3">
                        <span class="text-dark text-break" style="font-size: 14px;">@Model.Caption</span>
                        
                        @if (!string.IsNullOrEmpty(Model.Hashtags)) {
                            <div class="mt-2">
                                @foreach (var tag in Model.Hashtags.Split(' ', StringSplitOptions.RemoveEmptyEntries)) {
                                    <a href="#" class="text-primary text-decoration-none me-1 small">@tag</a>
                                }
                            </div>
                        }
                        <div class="text-muted mt-2" style="font-size: 11px;">@Model.CreatedAt.ToString("d MMMM, yyyy • HH:mm")</div>
                    </div>
                    <hr class="text-muted opacity-25 my-2">
                }

                <div id="commentList">
                    @if (Model.Comments != null && Model.Comments.Any()) {
                        foreach (var comment in Model.Comments) {
                            <div class="comment-item mb-3 d-flex">
                                <img src="/images/avatar.png" width="32" height="32" class="rounded-circle me-2" style="min-width: 32px; object-fit:cover; margin-top: 2px;">
                                
                                <div class="comment-body">
                                    <div class="bg-light p-2 px-3 rounded-4 d-inline-block" style="background-color: #f0f2f5 !important;">
                                        <strong class="d-block small text-dark">@comment.UserName</strong>
                                        <p class="mb-0 text-break small">@comment.Content</p>
                                    </div>
                                    <div class="d-flex gap-3 ms-2 mt-1 small text-muted">
                                        <span role="button" class="fw-bold" style="font-size: 11px;">Like</span>
                                        <span role="button" class="fw-bold" style="font-size: 11px;">Reply</span>
                                        <span style="font-size: 11px;">@comment.CreatedAt.ToString("HH:mm")</span>
                                    </div>
                                </div>
                            </div>
                        }
                    } else {
                        <div class="text-center py-4 no-comment-text">
                            <span class="text-muted small">No comments yet.</span>
                        </div>
                    }
                </div>
            </div>

            <div class="post-footer border-top p-3 bg-white">
                <div class="d-flex justify-content-between mb-2">
                    <div>
                        <i class="bi bi-heart fs-4 me-3 cursor-pointer" onclick="toggleLike(this, @Model.PostId)"></i>
                        <i class="bi bi-chat fs-4 me-3 cursor-pointer"></i>
                        <i class="bi bi-send fs-4 cursor-pointer"></i>
                    </div>
                    <i class="bi bi-bookmark fs-4 cursor-pointer"></i>
                </div>
                <p class="fw-bold mb-1 small">@Model.LikeCount likes</p>
                
                <div class="add-comment mt-3 position-relative d-flex align-items-center">
                    <input type="hidden" id="commentPostId" value="@Model.PostId" />
                    <input type="text" id="commentContent" class="form-control rounded-pill pe-5" placeholder="Add a comment..." style="font-size: 14px;">
                    <button class="btn btn-link text-primary fw-bold position-absolute end-0 text-decoration-none" 
                            onclick="postComment()" 
                            style="font-size: 14px;">Post</button>
                </div>
            </div>

        </div>
    </div>
</div>

<form asp-action="DeletePost" method="post" id="deleteForm" style="display: none;">
    <input type="hidden" name="postId" id="deletePostId" value="@Model.PostId" />
</form>

@section Scripts {
    <script src="~/js/post-detail.js"></script>

    <script>
        // Logic Comment (AJAX)
        function postComment() {
            const postId = document.getElementById("commentPostId").value;
            const contentInput = document.getElementById("commentContent");
            const content = contentInput.value.trim();

            if (!content) {
                contentInput.focus();
                return;
            }
            contentInput.disabled = true;

            fetch('/Comment/AddComment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ postId: parseInt(postId), content: content })
            })
            .then(res => {
                if (!res.ok) throw new Error("Failed");
                return res.json();
            })
            .then(newComment => {
                contentInput.value = "";
                const noCommentText = document.querySelector(".no-comment-text");
                if(noCommentText) noCommentText.style.display = 'none';

                const commentList = document.getElementById("commentList");
                
                // Template HTML Comment mới (Giống bên trên)
                const commentHtml = `
                    <div class="comment-item mb-3 d-flex">
                        <img src="/images/avatar.png" width="32" height="32" class="rounded-circle me-2" style="min-width: 32px; object-fit:cover; margin-top: 2px;">
                        <div class="comment-body">
                            <div class="bg-light p-2 px-3 rounded-4 d-inline-block" style="background-color: #f0f2f5 !important;">
                                <strong class="d-block small text-dark">${newComment.userName || 'You'}</strong>
                                <p class="mb-0 text-break small">${newComment.content}</p>
                            </div>
                            <div class="d-flex gap-3 ms-2 mt-1 small text-muted">
                                <span role="button" class="fw-bold" style="font-size: 11px;">Like</span>
                                <span role="button" class="fw-bold" style="font-size: 11px;">Reply</span>
                                <span style="font-size: 11px;">Just now</span>
                            </div>
                        </div>
                    </div>
                `;

                commentList.insertAdjacentHTML('beforeend', commentHtml);
                const commentsArea = document.querySelector(".comments-area");
                commentsArea.scrollTop = commentsArea.scrollHeight;
            })
            .catch(err => {
                console.error(err);
                alert("Failed to post comment.");
            })
            .finally(() => {
                contentInput.disabled = false;
                contentInput.focus();
            });
        }

        // Hỗ trợ Enter
        document.getElementById("commentContent").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                postComment();
            }
        });

        // Logic Xóa bài viết
        function confirmDelete(postId) {
            if (confirm("Are you sure you want to delete this post?")) {
                document.getElementById('deletePostId').value = postId;
                document.getElementById('deleteForm').submit();
            }
        }
    </script>
}