@using Microsoft.AspNetCore.Identity
@using System.Security.Claims
@inject UserManager<User> UserManager
@inject IHashtagService _hashtagService
@{
    User? currentUser = null;
    if (User.Identity != null && User.Identity.IsAuthenticated) {
        currentUser = await UserManager.GetUserAsync(User);
    }
    var userId = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
    var topHashtag = await _hashtagService.GetTopHashtag();
}

<div class="right-sidebar">
    <div class="sidebar-section">
        <div class="current-user-card">
            <img src="@currentUser.AvatarUrl" alt="User">
            <p class="current-user-name">@currentUser.FullName</p>
            <p class="current-user-handle">@currentUser.UserName</p>
            <a asp-controller="Profile" asp-action="MyProfile" class="view-profile-btn">View Profile</a>
        </div>
    </div>

    <div class="sidebar-section">
        <div class="sidebar-section-header">
            <h3 class="sidebar-section-title">Suggested for you</h3>
            <a href="/suggestions" class="see-all">See All</a>
        </div>
        <div class="suggested-user">
            <img src="/images/user1.jpg" class="suggested-user-avatar">
            <div class="suggested-user-info">
                <p class="suggested-user-name">Sarah Connor</p>
                <p class="suggested-user-mutual">5 mutual friends</p>
            </div>
            <button class="follow-btn">Follow</button>
        </div>
    </div>

    <div id="sidebar-ad-container" class="sidebar-section" style="display: none;">
        <div class="sidebar-section-header mb-2">
            <h3 class="sidebar-section-title text-muted" style="font-size: 11px; letter-spacing: 1px;">SPONSORED</h3>
        </div>

        <div class="ad-card position-relative rounded overflow-hidden shadow-sm border">
            <button type="button" class="btn-close position-absolute top-0 end-0 m-1 bg-white p-1" style="width: 6px; height: 6px; z-index: 10;" onclick="this.closest('.sidebar-section').remove()" aria-label="Close"></button>

            <a href="#" id="ad-target-link" target="_blank" class="text-decoration-none">
                <img id="ad-image" src="" alt="Advertisement" class="w-100 d-block" style="min-height: 250px; object-fit: cover;">

                <div class="p-3 bg-white">
                    <h6 id="ad-title" class="fw-bold text-dark mb-1" style="font-size: 14px;">Ad Title</h6>
                    <p id="ad-content" class="text-muted small mb-2 text-truncate" style="font-size: 12px;">Ad Content goes here...</p>
                    <div class="d-grid">
                        <button class="btn btn-primary btn-sm fw-bold" id="ad-cta">Learn More</button>
                    </div>
                </div>
            </a>
        </div>
    </div>
    <div class="sidebar-section">
        <div class="sidebar-section-header">
            <h3 class="sidebar-section-title">Trending Now</h3>
            <a href="/explore/trending" class="see-all">See All</a>
        </div>
        @foreach (var hashtag in topHashtag) {
            <div class="hashtag-item">
                <p class="hashtag-name">@hashtag.HashtagName</p>
                <p class="hashtag-count">@hashtag.UsageCount posts</p>
            </div>
        }
    </div>

    <div class="sidebar-section">
        <div class="sidebar-section-header">
            <h3 class="sidebar-section-title">Hot Reels</h3>
            <a href="/reels" class="see-all">See All</a>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        loadRandomBanner();
    });

    async function loadRandomBanner() {
        try {
            // Gọi API
            const response = await fetch('/Ad/GetRandomBanner');

            if (response.ok) {
                // Kiểm tra xem response có body không (tránh lỗi JSON parse empty)
                const text = await response.text();
                if (!text) return;

                const ad = JSON.parse(text);

                // Nếu có object Ad hợp lệ
                if (ad && ad.id) {
                    const container = document.getElementById('sidebar-ad-container');
                    const img = document.getElementById('ad-image');
                    const link = document.getElementById('ad-target-link');
                    const title = document.getElementById('ad-title');
                    const content = document.getElementById('ad-content');
                    const cta = document.getElementById('ad-cta');

                    // Gán dữ liệu vào HTML (CamelCase vì API trả về JSON)
                    img.src = ad.imageUrl;
                    link.href = ad.targetUrl;
                    title.innerText = ad.title;
                    content.innerText = ad.content || '';
                    cta.innerText = ad.ctaText || 'View';

                    // Hiển thị khung quảng cáo
                    container.style.display = 'block';

                    // Tracking Click (Gắn sự kiện)
                    link.onclick = function() {
                        // fetch(`/Ad/TrackClick?adId=${ad.id}`, { method: 'POST' });
                    };
                }
            }
        } catch (error) {
            console.error("Failed to load banner ad:", error);
        }
    }
</script>