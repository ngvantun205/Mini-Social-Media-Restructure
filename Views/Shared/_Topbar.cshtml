@using Microsoft.AspNetCore.Identity
@using System.Security.Claims
@inject UserManager<User> UserManager
@{
    User? currentUser = null;
    if (User.Identity != null && User.Identity.IsAuthenticated) {
        currentUser = await UserManager.GetUserAsync(User);
    }
    var userId = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;

    // Default avatar if user avatar is not available
    var avatarUrl = currentUser?.AvatarUrl ?? "/images/default-avatar.png";
    var fullName = currentUser?.FullName ?? "Guest User";
    var userName = currentUser?.UserName ?? "guest";
}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

<div class="top-bar">
    <div class="top-bar-left">
        <div class="search-container">
            <i class="fas fa-search search-icon" onclick="performSearch()" style="cursor: pointer;"></i>

            <input id="globalSearchInput" type="text" class="search-input"
                   placeholder="Search for friends, posts..."
                   autocomplete="off">
        </div>
    </div>

    <div class="top-bar-center">
        <a href="/" class="top-bar-logo">MySocial</a>
    </div>

    <div class="top-bar-right">
        @if (User.IsInRole("Admin")) {
            <a href="/Admin/Index" class="top-icon" data-page="index" title="Admin">
                <i class="fas fa-admin"></i>
            </a>
        }
        <a href="/" class="top-icon" data-page="home" title="Home">
            <i class="fas fa-home"></i>
        </a>

        <a href="/Message" class="top-icon" data-page="messages" title="Messages">
            <i class="fas fa-comment"></i>
            <span class="badge">3</span>
        </a>

        <div class="user-dropdown">
            <img src="@avatarUrl" alt="User" class="user-avatar-top">

            <div class="dropdown-menu">
                <div class="dropdown-header">
                    <div class="dropdown-user-info">
                        <img src="@avatarUrl" alt="User">
                        <div class="dropdown-user-details">
                            <p class="dropdown-user-name">@fullName</p>
                            <p class="dropdown-user-handle">@@@userName</p>
                        </div>
                    </div>
                </div>

                <div class="dropdown-body">
                    <a asp-controller="Profile" asp-action="MyProfile" class="dropdown-item">
                        <i class="fas fa-user"></i>
                        <span>Profile</span>
                    </a>

                    <a asp-controller="Account" asp-action="Edit" class="dropdown-item">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </a>

                    <a href="/saved" class="dropdown-item">
                        <i class="fas fa-bookmark"></i>
                        <span>Saved Posts</span>
                    </a>

                    <a href="/help" class="dropdown-item">
                        <i class="fas fa-question-circle"></i>
                        <span>Help & Support</span>
                    </a>

                    <a asp-controller="Auth" asp-action="Logout" class="dropdown-item logout">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="~/js/topbar.js"></script>

<script>
    // 1. Lắng nghe sự kiện khi trang đã load
    document.addEventListener("DOMContentLoaded", function() {
        const searchInput = document.getElementById("globalSearchInput");

        if (searchInput) {
            // 2. Bắt sự kiện phím Enter (Key Code 13)
            searchInput.addEventListener("keypress", function(event) {
                if (event.key === "Enter") {
                    event.preventDefault(); // Ngăn chặn hành vi mặc định (nếu có form)
                    performSearch();
                }
            });
        }
    });

    // 3. Hàm thực hiện tìm kiếm (Chuyển hướng)
    function performSearch() {
        const input = document.getElementById("globalSearchInput");
        const query = input.value.trim();

        if (query) {
            // Chuyển hướng sang trang Search Controller kèm tham số
            // encodeURIComponent để xử lý các ký tự đặc biệt như dấu cách, &, ?
            window.location.href = `/Search/Search?searchinfo=${encodeURIComponent(query)}`;
        } else {
            input.focus(); // Nếu rỗng thì focus lại để nhập
        }
    }
</script>