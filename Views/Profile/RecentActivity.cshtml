@using Mini_Social_Media.Models.ViewModel
@{
    ViewData["Title"] = "Hoạt động gần đây";
    
    var likeHistory = ViewBag.LikeHistory as List<LikeViewModel> ?? new List<LikeViewModel>();
    var commentHistory = ViewBag.CommentHistory as List<CommentViewModel> ?? new List<CommentViewModel>();
}

@section Styles {
    <style>
        .activity-item {
            transition: all 0.2s ease;
            border-left: 4px solid transparent;
        }
        .activity-item:hover {
            background-color: #f8f9fa;
            border-left-color: #0d6efd;
            transform: translateX(5px);
        }
        .activity-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        .bg-like-soft { background-color: #ffeef0; color: #dc3545; }
        .bg-comment-soft { background-color: #e7f1ff; color: #0d6efd; }
        
        .nav-pills .nav-link.active {
            background-color: #0d6efd;
            font-weight: bold;
        }
        .nav-pills .nav-link {
            color: #495057;
        }
    </style>
}

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm border-0 rounded-4">
                <div class="card-header bg-white border-bottom-0 pt-4 pb-0">
                    <h4 class="mb-3 fw-bold"><i class="bi bi-clock-history me-2"></i>Hoạt động gần đây</h4>
                    
                    <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active rounded-pill px-4" id="pills-likes-tab" data-bs-toggle="pill" data-bs-target="#pills-likes" type="button" role="tab">
                                <i class="bi bi-heart-fill me-2"></i> Lượt thích (@likeHistory.Count)
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link rounded-pill px-4" id="pills-comments-tab" data-bs-toggle="pill" data-bs-target="#pills-comments" type="button" role="tab">
                                <i class="bi bi-chat-dots-fill me-2"></i> Bình luận (@commentHistory.Count)
                            </button>
                        </li>
                    </ul>
                </div>

                <div class="card-body p-0">
                    <div class="tab-content" id="pills-tabContent">
                        
                        <div class="tab-pane fade show active" id="pills-likes" role="tabpanel">
                            @if (likeHistory.Any())
                            {
                                <div class="list-group list-group-flush">
                                    @foreach (var item in likeHistory.OrderByDescending(x => x.CreatedAt))
                                    {
                                        <a asp-controller="Post" asp-action="PostDetails" asp-route-id="@item.PostId" class="list-group-item list-group-item-action activity-item p-3">
                                            <div class="d-flex align-items-center">
                                                <div class="activity-icon bg-like-soft me-3">
                                                    <i class="bi bi-heart-fill fs-5"></i>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <div class="text-dark">
                                                        Bạn đã thích bài viết của <span class="fw-bold">@item.PostUsername</span>
                                                    </div>
                                                    <small class="text-muted">
                                                        <i class="bi bi-clock"></i> @GetTimeAgo(item.CreatedAt)
                                                    </small>
                                                </div>
                                                <i class="bi bi-chevron-right text-muted small"></i>
                                            </div>
                                        </a>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="text-center py-5 text-muted">
                                    <i class="bi bi-heart display-4 mb-3 d-block opacity-50"></i>
                                    <p>Bạn chưa thích bài viết nào gần đây.</p>
                                </div>
                            }
                        </div>

                        <div class="tab-pane fade" id="pills-comments" role="tabpanel">
                            @if (commentHistory.Any())
                            {
                                <div class="list-group list-group-flush">
                                    @foreach (var item in commentHistory.OrderByDescending(x => x.CreatedAt))
                                    {
                                        <a asp-controller="Post" asp-action="PostDetails" asp-route-id="@item.PostId" class="list-group-item list-group-item-action activity-item p-3">
                                            <div class="d-flex align-items-start">
                                                <div class="activity-icon bg-comment-soft me-3 mt-1">
                                                    <i class="bi bi-chat-left-text-fill fs-5"></i>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <div class="text-dark mb-1">
                                                        Bạn đã bình luận vào bài viết của <span class="fw-bold">@item.PostUsername</span>
                                                    </div>
                                                    <div class="bg-light p-2 rounded-3 text-muted fst-italic small mb-1 border">
                                                        " @(item.Content.Length > 50 ? item.Content.Substring(0, 50) + "..." : item.Content) "
                                                    </div>
                                                    <small class="text-muted">
                                                        <i class="bi bi-clock"></i> @GetTimeAgo(item.CreatedAt)
                                                    </small>
                                                </div>
                                                <i class="bi bi-chevron-right text-muted small mt-2"></i>
                                            </div>
                                        </a>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="text-center py-5 text-muted">
                                    <i class="bi bi-chat-square-text display-4 mb-3 d-block opacity-50"></i>
                                    <p>Bạn chưa bình luận vào bài viết nào gần đây.</p>
                                </div>
                            }
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@functions {
    string GetTimeAgo(DateTime date)
    {
        var span = DateTime.UtcNow - date;
        if (span.TotalMinutes < 1) return "Vừa xong";
        if (span.TotalMinutes < 60) return $"{(int)span.TotalMinutes} phút trước";
        if (span.TotalHours < 24) return $"{(int)span.TotalHours} giờ trước";
        if (span.TotalDays < 7) return $"{(int)span.TotalDays} ngày trước";
        return date.ToString("dd/MM/yyyy");
    }
}